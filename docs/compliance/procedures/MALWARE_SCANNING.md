# File Upload Malware Scanning Procedure

**Document ID:** PROC-SEC-003  
**Version:** 1.0  
**Effective Date:** February 12, 2026  
**Last Review:** February 12, 2026  
**Next Review:** August 12, 2026  
**Owner:** Security Team Lead  
**Approved By:** Chief Technology Officer

---

## 1. Purpose

This procedure establishes requirements for scanning all user-uploaded files for malware, viruses, and malicious content to protect Union Eyes systems, data, and users from security threats.

---

## 2. Scope

**Covered File Types:**
- Documents (.pdf, .doc, .docx, .xls, .xlsx, .ppt, .pptx)
- Images (.jpg, .jpeg, .png, .gif, .bmp,webp, .svg)
- Archives (.zip, .tar, .gz, .rar, .7z)
- Text files (.txt, .csv, .rtf)
- Digital signatures and certificates

**Upload Locations:**
- Member profile pictures
- Union document uploads (collective agreements, policies, bylaws)
- Grievance attachments
- Arbitration case documents
- Meeting minutes and agendas
- Training materials and resources

**Out of Scope:**
- System-generated files
- Files uploaded by automated processes from trusted sources
- Administrator-uploaded files (manual security review instead)

---

## 3. Threat Model

### 3.1 Attack Vectors
**Infected Documents:**
- Macro viruses in Microsoft Office documents
- PDF exploits (JavaScript, embedded executables)
- Polyglot files (valid file + embedded malware)

**Malicious Archives:**
- Zip bombs (extreme compression ratios causing DoS)
- Archive with nested malware
- Path traversal attacks in filenames

**Image-Based Attacks:**
- Steganography (data hidden in images)
- Image format vulnerabilities (buffer overflows)
- SVG with embedded JavaScript

**Zero-Day Exploits:**
- Unknown vulnerabilities in file parsers
- Emerging malware families

### 3.2 Impact
**If Malware Uploaded:**
- User device infection (member download and open)
- Server compromise (if file processed server-side)
- Data exfiltration (union documents, member PII)
- Ransomware propagation
- Reputational damage

---

## 4. Scanning Architecture

### 4.1 Implementation Approach
**Option 1: Azure Blob Storage Defender for Cloud (Recommended)**
- Microsoft Defender for Storage with malware scanning
- Real-time scanning on upload
- Integration with Azure Blob Storage
- Cost: ~$10-15/month per storage account

**Option 2: ClamAV (Open-Source Alternative)**
- Self-hosted antivirus engine
- Integration via Azure Function or Docker container
- Free (infrastructure costs only)
- Requires signature updates management

**Option 3: Third-Party API (VirusTotal, MetaDefender)**
- Cloud-based multi-engine scanning
- 40+ antivirus engines
- Cost: $0-$500/month depending on volume
- Privacy concern: Files sent to third-party

**Selected Approach:** Azure Blob Storage Defender for Cloud (to be implemented Q2 2026)

### 4.2 Scanning Workflow

```
┌─────────────────┐
│  User Upload    │
│  (Next.js App)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ File Validation │ ◄─── Size, type, filename checks
│  (API Route)    │
└────────┬────────┘
         │ Passed
         ▼
┌─────────────────┐
│ Azure Blob      │
│ Storage Upload  │ ◄─── Temporary "quarantine" container
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Defender Scan   │ ◄─── Automatic malware scan
│ (Real-time)     │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌─────────┐
│ Clean  │ │Infected │
└───┬────┘ └────┬────┘
    │           │
    ▼           ▼
┌────────┐ ┌──────────┐
│ Move to│ │  Delete  │
│ Prod   │ │  + Alert │
└────────┘ └──────────┘
```

**Upload Flow:**
1. User submits file via web form
2. Frontend validation (size, type, filename)
3. Backend API route receives file
4. Pre-scan validation (size limits, magic byte verification)
5. Upload to Azure Blob "quarantine" container
6. Azure Defender scans file (1-3 seconds for small files)
7. If clean: Move to production container, update database record
8. If infected: Delete file, log incident, notify user (generic error)
9. Return success/failure to frontend

---

## 5. Pre-Scan Validation

### 5.1 File Size Limits
**Purpose:** Prevent DoS attacks and excessive storage costs  

**Limits by Category:**
- Profile pictures: 5 MB maximum
- Documents: 25 MB maximum
- Archives: 50 MB maximum
- Individual limits prevent large file attacks

**Enforcement:** Next.js API route + frontend validation

### 5.2 Allowed File Types
**Whitelist Approach:** Only explicitly allowed MIME types accepted

**Allowed Types:**
```typescript
const ALLOWED_MIME_TYPES = {
  images: [
    'image/jpeg',
    'image/png',
    'image/gif',
    'image/webp'
  ],
  documents: [
    'application/pdf',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
    'application/vnd.openxmlformats-officedocument.presentationml.presentation', // .pptx
    'application/msword', // .doc
    'application/vnd.ms-excel', // .xls
    'text/plain',
    'text/csv'
  ],
  archives: [
    'application/zip',
    'application/x-tar',
    'application/gzip'
  ]
};
```

**Validation:** Magic byte verification (not just file extension)
```typescript
// Example using 'file-type' library
import { fileTypeFromBuffer } from 'file-type';

const buffer = await file.arrayBuffer();
const fileType = await fileTypeFromBuffer(buffer);

if (!ALLOWED_MIME_TYPES.documents.includes(fileType?.mime)) {
  throw new Error('Invalid file type');
}
```

### 5.3 Filename Sanitization
**Purpose:** Prevent path traversal, XSS, command injection

**Rules:**
- Remove directory separators (/, \, ..)
- Remove null bytes (\0)
- Limit length (255 characters)
- Allow only: alphanumeric, dash, underscore, period
- Preserve original extension (validated against MIME type)
- Generate unique filename: `{uuid}-{sanitized-name}.{ext}`

**Implementation:**
```typescript
function sanitizeFilename(originalFilename: string): string {
  const ext = path.extname(originalFilename).toLowerCase();
  const name = path.basename(originalFilename, ext);
  
  const sanitized = name
    .replace(/[^a-zA-Z0-9-_]/g, '_')
    .substring(0, 200);
  
  const uniqueId = crypto.randomUUID();
  return `${uniqueId}-${sanitized}${ext}`;
}
```

### 5.4 Archive Inspection
**Purpose:** Detect zip bombs and nested malware

**Checks:**
- Maximum uncompressed size: 500 MB
- Maximum compression ratio: 100:1 (reject if exceeded)
- Maximum nested depth: 3 levels
- Maximum number of files: 1,000

**Implementation:** Pre-scan with zip library before uploading to Blob Storage
```typescript
import AdmZip from 'adm-zip';

const zip = new AdmZip(buffer);
const entries = zip.getEntries();

let totalUncompressedSize = 0;
for (const entry of entries) {
  totalUncompressedSize += entry.getData().length;
  
  if (totalUncompressedSize > 500 * 1024 * 1024) {
    throw new Error('Archive too large when uncompressed');
  }
  
  const ratio = entry.getData().length / entry.header.compressedSize;
  if (ratio > 100) {
    throw new Error('Suspicious compression ratio detected');
  }
}
```

---

## 6. Malware Scanning

### 6.1 Azure Defender for Storage Configuration
**Setup Steps:**
1. Enable Microsoft Defender for Cloud in Azure subscription
2. Enable Defender for Storage on Union Eyes storage account
3. Configure malware scanning settings:
   - Scan on upload: Enabled
   - Sensitive data discovery: Enabled (future)
   - Monthly cap: None (scan all uploads)
4. Configure alert routing to Azure Monitor + Slack

**Scan Coverage:**
- All containers: Yes
- Scan on upload: Real-time (immediate)
- Scan results: Metadata tags on blob (`MalwareScanResult`, `MalwareScanTimestamp`)

**Scanning Engine:** Microsoft Antimalware (multi-engine)

### 6.2 Scan Result Handling

**Blob Metadata Tags:**
```
MalwareScanResult: Clean | Infected | Error
MalwareScanTimestamp: 2026-02-12T14:30:00Z
MalwareThreatName: (if infected, e.g., "Trojan:Win32/Emotet.A")
```

**Application Logic:**
```typescript
async function checkScanResult(blobUrl: string): Promise<'clean' | 'infected' | 'pending'> {
  const blobClient = new BlobClient(blobUrl);
  const metadata = await blobClient.getProperties();
  
  const result = metadata.metadata?.malwarescanresult;
  
  if (result === 'Clean') return 'clean';
  if (result === 'Infected') return 'infected';
  return 'pending'; // Scan in progress
}
```

**Quarantine Container:**
- Name: `uploads-quarantine`
- Lifecycle: Delete after 7 days (automatic cleanup policy)
- Access: Private (no public access)

**Production Container:**
- Name: `uploads-production`
- Lifecycle: Per data retention policy
- Access: Authenticated users with RLS checks

### 6.3 Scan Timing
**Real-time Scanning:**
- Small files (<10 MB): 1-3 seconds
- Medium files (10-50 MB): 5-10 seconds
- Large files (>50 MB): 10-30 seconds

**Application Handling:**
- Upload to quarantine: Immediate return to user ("Upload successful, processing...")
- Background job polls scan result every 2 seconds (max 30 second timeout)
- Update database record when scan complete
- Notify user via WebSocket or polling (file ready for download)

---

## 7. Infected File Response

### 7.1 Immediate Actions
**When Infected File Detected:**
1. **Delete file** from quarantine container (automatic)
2. **Log security event** (Sentry + Azure Monitor)
   ```json
   {
     "eventType": "malware_detected",
     "severity": "high",
     "timestamp": "2026-02-12T14:30:00Z",
     "userId": "user_xxx",
     "filename": "document.pdf",
     "malwareType": "Trojan:Win32/Emotet.A",
     "sourceIP": "192.168.1.100",
     "userAgent": "Mozilla/5.0..."
   }
   ```
3. **Alert security team** (Slack #security-alerts)
4. **Update database record** (mark upload as failed)
5. **Return generic error to user** (do not reveal malware detection to avoid attacker reconnaissance)
   - Message: "File upload failed. Please ensure the file is valid and try again."

### 7.2 User Notification
**Generic Error Response:**
```typescript
return {
  success: false,
  error: "FILE_UPLOAD_FAILED",
  message: "Unable to process your file. Please ensure it's a valid document and try again. If the problem persists, contact support."
};
```

**Do NOT reveal:**
- Malware detected
- Threat name
- Scanning system details

**Rationale:** Prevent attackers from testing bypasses

### 7.3 Incident Investigation
**For Each Malware Detection:**
1. **Review user account** (suspicious activity, account compromise indicators)
2. **Check upload history** (multiple infected files = potential attacker)
3. **IP address analysis** (known malicious IP, VPN, unusual geolocation)
4. **Notify user (if legitimate)** via email (separate from error message):
   - "We detected a security issue with your recent file upload. This may indicate your device is infected. Please scan your device with antivirus software."
5. **Escalate if coordinated attack** (multiple users, same malware family)

### 7.4 Metrics and Reporting
**Weekly Report Contents:**
- Total files scanned
- Infected files detected (count and percentage)
- Malware families identified (top 5)
- User accounts with multiple detections
- Trends (increasing/decreasing infection rate)

**Distribution:** Security team + CTO

---

## 8. False Positive Handling

### 8.1 User Appeal Process
**If User Reports Legitimate File Blocked:**
1. User contacts support: support@unioneyes.com
2. Support creates ticket and forwards to security team
3. Security team manually rese-scans file:
   - VirusTotal multi-engine scan (40+ engines)
   - Manual inspection (if safe file type like PDF, txt)
   - Sandbox analysis (if executable component)
4. If confirmed false positive:
   - Whitelist file hash (if recurring issue)
   - Allow manual upload by admin
   - Report false positive to Microsoft
5. If confirmed malware:
   - Explain to user (security concern)
   - Offer alternative (sanitize document, extract text only)

**Timeframe:** 2 business days

### 8.2 Whitelisting (Cautious Use)
**Criteria for Whitelisting:**
- Verified false positive from reputable source
- Business-critical file (e.g., government form template)
- Confirmed clean by 3+ independent scans (VirusTotal)

**Whitelist Storage:** Database table `malware_scan_whitelist`
```sql
CREATE TABLE malware_scan_whitelist (
  id UUID PRIMARY KEY,
  file_hash TEXT NOT NULL, -- SHA256
  filename TEXT,
  reason TEXT NOT NULL,
  approved_by TEXT NOT NULL, -- CTO or Security Lead
  approved_date TIMESTAMPTZ NOT NULL,
  expiry_date TIMESTAMPTZ, -- NULL = permanent
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Review Frequency:** Quarterly (remove outdated entries)

---

## 9. Backup and Recovery Considerations

### 9.1 Infected File in Backup
**Risk:** Backup restore could reintroduce malware

**Mitigation:**
- Backup scanning: Azure Backup includes Defender scanning
- Restore procedure: Scan all restored files before making accessible
- Backup retention: Follow data retention policy (infected files purged after 30 days)

### 9.2 Disaster Recovery
**If Scanning Service Unavailable:**
- Option 1: Queue uploads for later scanning (max 24 hours)
- Option 2: Temporary manual review by security team
- Option 3: Disable uploads until service restored (for critical malware outbreak)

**Decision Matrix:**
- Minor outage (<2 hours): Queue uploads
- Extended outage (>4 hours): Manual review
- Zero-day outbreak: Disable uploads

---

## 10. Performance and Scalability

### 10.1 Current Volume Estimates
- Average uploads per day: 50-100 files
- Peak uploads: 200 files/day (post-meeting document submissions)
- Average file size: 2-5 MB

**Azure Defender Capacity:** Unlimited (cloud-based scaling)

### 10.2 Optimization Strategies
**If High Volume:**
- Pre-filter obvious malware (known file signatures)
- Parallel scanning (multiple files simultaneously)
- Scan prioritization (critical document types first)

### 10.3 Cost Management
**Azure Defender for Storage Pricing (as of 2026):**
- Per storage account: $10/month
- Per GB scanned: $0.02/GB
- Estimated monthly cost: $15-25 (low volume)

**Budget Alert:** If cost exceeds $100/month (investigate unusual activity)

---

## 11. Testing and Validation

### 11.1 EICAR Test File
**Purpose:** Validate malware detection without real malware

**Test File:** Standard EICAR anti-virus test file
```
X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
```

**Test Procedure:**
1. Create EICAR.txt file with above content
2. Upload via application
3. Verify detection and deletion
4. Check alert received in Slack
5. Verify log entry created

**Frequency:** Monthly (automated test)

### 11.2 Bypas Attempt Testing (Penetration Test)
**Frequency:** Quarterly (as part of penetration testing schedule)

**Test Scenarios:**
- Obfuscated malware (encrypted, packed)
- Polyglot files (valid PDF + embedded executable)
- Archive with nested malware
- Zip bomb attack
- Path traversal in filenames
- XSS in metadata (filename, EXIF data)

**Acceptance Criteria:** All attacks detected or mitigated

---

## 12. Compliance and Audit

### 12.1 ISO 27001 Controls
**Mapped Controls:**
- A.8.7 - Protection against malware
- A.8.28 - Secure coding (input validation)

**Evidence:**
- Malware scanning logs (scan results, detections)
- Configuration screenshots (Azure Defender settings)
- Incident response records (malware detections and actions taken)
- Test results (EICAR tests, penetration test reports)

### 12.2 Audit Trail
**Logged Events:**
- File upload initiated (user, filename, size, timestamp)
- Scan started (scan ID, timestamp)
- Scan completed (result: clean/infected, threat name if infected)
- File moved to production or deleted
- User notified

**Retention:** 90 days (hot), 1 year (archived per Data Retention Policy)

**Access:** Security team, auditors (read-only)

---

## 13. User Education

### 13.1 Security Awareness
**Topics:**
- Why files are scanned (protect union and members)
- What file types are allowed
- How to avoid uploading infected files (keep devices updated, use antivirus)
- What to do if upload fails (contact support if legitimate file)

**Training Delivery:**
- Onboarding security training (part of 90-minute session)
- Annual refresher (part of 60-minute session)
- Help center article: "File Upload Security"

### 13.2 Admin Training
**Additional Topics for Admins:**
- How malware scanning works
- How to investigate malware detections
- False positive appeal process
- Incident escalation procedures

**Training Delivery:** Role-specific training (2 hours)

---

## 14. Future Enhancements

### 14.1 Planned Improvements (2026-2027)
- **Content Disarm and Reconstruction (CDR):** Sanitize documents by removing active content (macros, JavaScript) while preserving layout
- **Sandboxing:** Execute suspicious files in isolated Azure Container Instance to detect behavior-based malware
- **Machine Learning Detection:** Anomaly detection for zero-day malware
- **DLP Integration:** Scan for sensitive data (PII, credit cards) in uploaded files beyond just malware

### 14.2 Continuous Improvement
**Quarterly Review:**
- False positive rate analysis
- Detection rate trends
- Performance optimization opportunities
- Cost vs. benefit analysis

---

## 15. Roles and Responsibilities

| Role | Responsibilities |
|------|-----------------|
| **Security Team Lead** | Policy oversight, incident investigation, false positive review, whitelist approval |
| **DevOps Lead** | Azure Defender configuration, monitoring setup, cost management |
| **Lead Developer** | Application integration, API route implementation, error handling |
| **Support Team** | User appeals handling, ticket management, security team escalation |
| **CTO** | Budget approval, policy approval, strategic decisions |

---

## 16. Related Documents

- [Information Security Policy](../policies/INFORMATION_SECURITY_POLICY.md)
- [Secure SDLC Policy](../policies/SECURE_SDLC_POLICY.md)
- [Incident Response Plan](../policies/INCIDENT_RESPONSE_PLAN.md)
- [Data Classification Policy](../policies/DATA_CLASSIFICATION_POLICY.md)

---

## 17. Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | February 12, 2026 | Security Team Lead | Initial procedure creation |

---

**Approved:**  
________________________________  
Chief Technology Officer

**Date:** February 12, 2026
