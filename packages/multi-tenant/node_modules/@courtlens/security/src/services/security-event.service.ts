// CourtLens Security Event Service
// Centralized security event logging and monitoring

import { createClient, SupabaseClient } from '@supabase/supabase-js';
import { SecurityEvent, RiskLevel } from '../types';

export class SecurityEventService {
  private supabase: SupabaseClient;

  constructor(supabaseUrl?: string, supabaseKey?: string) {
    if (supabaseUrl && supabaseKey) {
      this.supabase = createClient(supabaseUrl, supabaseKey);
    } else {
      // Use environment variables if not provided
      this.supabase = createClient(
        process.env.SUPABASE_URL || '',
        process.env.SUPABASE_SERVICE_ROLE_KEY || ''
      );
    }
  }

  async logEvent(event: SecurityEvent): Promise<void> {
    try {
      const { error } = await this.supabase
        .from('security_events')
        .insert([event]);

      if (error) {
        console.error('Failed to log security event:', error);
      }

      // For high/critical risk events, trigger immediate alerts
      if (event.riskLevel === RiskLevel.HIGH || event.riskLevel === RiskLevel.CRITICAL) {
        await this.triggerAlert(event);
      }
    } catch (error) {
      console.error('Security event logging failed:', error);
    }
  }

  private async triggerAlert(event: SecurityEvent): Promise<void> {
    // TODO: Implement alerting mechanism (email, Slack, etc.)
    console.log('SECURITY ALERT:', event);
  }
}