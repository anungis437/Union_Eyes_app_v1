import { Request, Response, NextFunction } from 'express';
import { EventEmitter } from 'events';
import { EnterpriseSSOService } from '../services/enterprise-sso.service';
import { EnterpriseRBACService } from '../services/enterprise-rbac.service';
import { EnterpriseMFAService } from '../services/enterprise-mfa.service';
import { EnterpriseAuditService } from '../services/enterprise-audit.service';
/**
 * Enhanced security middleware for enterprise authentication and authorization
 */
export interface SecurityConfig {
    sso: {
        enabled: boolean;
        providers: string[];
        autoProvisioning: boolean;
        defaultRoles: string[];
    };
    mfa: {
        enabled: boolean;
        required: boolean;
        riskBasedEnabled: boolean;
        trustedDeviceEnabled: boolean;
    };
    rbac: {
        enabled: boolean;
        cacheEnabled: boolean;
        inheritanceEnabled: boolean;
    };
    rateLimit: {
        windowMs: number;
        max: number;
        skipSuccessfulRequests: boolean;
    };
    headers: {
        contentSecurityPolicy: boolean;
        hsts: boolean;
        xssFilter: boolean;
        noSniff: boolean;
    };
}
export interface AuthenticatedRequest extends Request {
    user?: {
        id: string;
        email: string;
        name: string;
        tenantId?: string;
        organizationId?: string;
        ssoProvider?: string;
        mfaVerified: boolean;
        sessionId: string;
        roles: string[];
        permissions: string[];
        lastActivity: Date;
        riskScore: number;
    };
    session?: {
        id: string;
        userId: string;
        createdAt: Date;
        lastActivity: Date;
        ipAddress: string;
        userAgent: string;
        mfaVerified: boolean;
        trustedDevice: boolean;
        riskAssessment?: {
            level: 'low' | 'medium' | 'high' | 'critical';
            score: number;
            factors: string[];
        };
    };
}
export interface SecurityContext {
    userId: string;
    sessionId: string;
    ipAddress: string;
    userAgent: string;
    tenantId?: string;
    organizationId?: string;
    timestamp: Date;
    mfaVerified: boolean;
    ssoProvider?: string;
    deviceFingerprint?: string;
    geolocation?: {
        country: string;
        city: string;
        coordinates?: [number, number];
    };
}
/**
 * Enterprise Security Middleware
 * Provides comprehensive security features including SSO, MFA, RBAC, and audit logging
 */
export declare class EnterpriseSecurityMiddleware extends EventEmitter {
    private config;
    private ssoService;
    private rbacService;
    private mfaService;
    private auditService;
    private activeSessions;
    private rateLimiters;
    constructor(config: SecurityConfig, ssoService: EnterpriseSSOService, rbacService: EnterpriseRBACService, mfaService: EnterpriseMFAService, auditService: EnterpriseAuditService);
    /**
     * Initialize security middleware stack
     */
    initializeMiddleware(): (((req: import("http").IncomingMessage, res: import("http").ServerResponse, next: (err?: unknown) => void) => void) | import("express-rate-limit").RateLimitRequestHandler | ((req: AuthenticatedRequest, res: Response, next: NextFunction) => Promise<void | Response<any, Record<string, any>>>))[];
    /**
     * Security headers middleware
     */
    private securityHeaders;
    /**
     * Rate limiting middleware
     */
    private rateLimiting;
    /**
     * Session validation middleware
     */
    private sessionValidation;
    /**
     * Authentication middleware
     */
    private authentication;
    /**
     * MFA validation middleware
     */
    private mfaValidation;
    /**
     * Authorization middleware
     */
    private authorization;
    /**
     * Audit logging middleware
     */
    private auditLogging;
    /**
     * Build security context from request
     */
    private buildSecurityContext;
    /**
     * Handle MFA challenge initiation
     */
    private initiateMFA;
    /**
     * Handle MFA challenge response
     */
    private handleMFAChallenge;
    /**
     * Check if MFA is required for this request
     */
    private isMFARequired;
    /**
     * Extract session ID from request
     */
    private extractSessionId;
    /**
     * Get required permission for endpoint
     */
    private getRequiredPermission;
    /**
     * Check if endpoint is public (no authentication required)
     */
    private isPublicEndpoint;
    /**
     * Check if MFA should be skipped for endpoint
     */
    private skipMFAForEndpoint;
    /**
     * Handle unauthenticated requests
     */
    private handleUnauthenticated;
    /**
     * Handle unauthorized requests
     */
    private handleUnauthorized;
    /**
     * Handle invalid sessions
     */
    private handleInvalidSession;
    /**
     * Handle security errors
     */
    private handleSecurityError;
    /**
     * Get audit severity based on request/response
     */
    private getAuditSeverity;
    /**
     * Get compliance flags for audit
     */
    private getComplianceFlags;
    /**
     * Sanitize headers for logging
     */
    private sanitizeHeaders;
    /**
     * Setup rate limiters for different endpoint types
     */
    private setupRateLimiters;
    /**
     * Setup security headers configuration
     */
    private setupSecurityHeaders;
    /**
     * Validate bearer token
     */
    private validateBearerToken;
    /**
     * Get user from session
     */
    private getUserFromSession;
    /**
     * Get user permissions from roles
     */
    private getUserPermissions;
}
/**
 * Factory function to create security middleware
 */
export declare function createSecurityMiddleware(config: SecurityConfig, services: {
    ssoService: EnterpriseSSOService;
    rbacService: EnterpriseRBACService;
    mfaService: EnterpriseMFAService;
    auditService: EnterpriseAuditService;
}): EnterpriseSecurityMiddleware;
/**
 * Default security configuration for enterprise deployment
 */
export declare const defaultSecurityConfig: SecurityConfig;
//# sourceMappingURL=enterprise-security.middleware.d.ts.map