# CourtLens Security Framework Documentation

## Overview

The CourtLens Security Framework provides enterprise-grade security capabilities for legal technology applications, including authentication, authorization, encryption, and comprehensive security monitoring. Built with Supabase integration and designed specifically for legal industry requirements.

## üîê Features

### Authentication

- **Multi-Factor Authentication (MFA)** with TOTP and backup codes
- **JWT-based session management** with automatic refresh
- **Supabase integration** for scalable user management
- **Password policy enforcement** with strength validation
- **Account lockout protection** against brute force attacks
- **Device fingerprinting** for enhanced security

### Authorization

- **Role-Based Access Control (RBAC)** with hierarchical permissions
- **Organization-level isolation** for multi-tenant security
- **Resource-based permissions** with conditional access
- **Permission caching** for optimal performance
- **Legal domain-specific roles** (Partner, Associate, Paralegal, Client)

### Encryption

- **AES-256 encryption** with multiple security levels
- **File encryption** for document protection
- **Key management** with automatic rotation
- **Secure hashing** for sensitive data
- **Legal document classification** based encryption

### Security Monitoring

- **Real-time security event logging**
- **Suspicious activity detection**
- **Audit trail** for compliance requirements
- **Security alerts** for high-risk events
- **Compliance reporting** for legal standards

## üöÄ Quick Start

### Installation

```bash
cd packages/security
pnpm install
pnpm build
```

### Basic Setup

```typescript
import { createSecurityFramework } from '@courtlens/security';

// Initialize security framework
const security = createSecurityFramework({
  supabase: {
    url: 'https://qzkopgqmymorpngpabvq.supabase.co',
    serviceRoleKey: process.env.SUPABASE_SERVICE_ROLE_KEY,
    anonKey: process.env.SUPABASE_ANON_KEY
  },
  jwt: {
    secret: process.env.JWT_SECRET,
    expiresIn: '1h'
  },
  encryption: {
    defaultLevel: 'enhanced'
  }
});
```

### Express.js Integration

```typescript
import express from 'express';
import { createSecurityFramework } from '@courtlens/security';

const app = express();
const security = createSecurityFramework();
const middleware = security.getExpressConfig();

// Apply security middleware
app.use(middleware.securityHeaders);
app.use(middleware.rateLimit);
app.use(middleware.cors);
app.use(middleware.requestLogger);

// Protected routes
app.post('/api/login', 
  middleware.authRateLimit,
  middleware.validateInput([
    ValidationSchemas.email,
    ValidationSchemas.password
  ]),
  async (req, res) => {
    try {
      const { email, password, mfaToken } = req.body;
      const tokens = await security.authentication.login(
        { email, password, mfaToken },
        { ipAddress: req.ip, userAgent: req.get('User-Agent') }
      );
      res.json(tokens);
    } catch (error) {
      res.status(401).json({ error: error.message });
    }
  }
);

// Authenticated routes
app.use('/api/protected', middleware.authenticate());

// Authorized routes
app.get('/api/admin/*', 
  middleware.authenticate(),
  middleware.authorize({ resource: 'admin', action: 'read' })
);

// Error handling
app.use(middleware.errorHandler);
```

## üìö API Reference

### Authentication Service

#### `login(credentials, context)`

Authenticate user with email/password and optional MFA.

```typescript
const tokens = await security.authentication.login(
  {
    email: 'user@lawfirm.com',
    password: 'SecurePassword123!',
    mfaToken: '123456' // Optional MFA token
  },
  {
    ipAddress: '192.168.1.100',
    userAgent: 'Mozilla/5.0...'
  }
);
```

#### `register(userData, context)`

Register new user account.

```typescript
const user = await security.authentication.register(
  {
    email: 'new@lawfirm.com',
    password: 'SecurePassword123!',
    firstName: 'John',
    lastName: 'Doe',
    organizationId: 'org-123',
    role: UserRole.ASSOCIATE
  },
  { ipAddress: req.ip, userAgent: req.get('User-Agent') }
);
```

#### `setupMfa(userId)`
Setup multi-factor authentication for user.

```typescript
const mfaSetup = await security.authentication.setupMfa('user-123');
// Returns: { secret, qrCodeUrl, backupCodes }
```

#### `verifyMfaToken(userId, token)`
Verify MFA token or backup code.

```typescript
const isValid = await security.authentication.verifyMfaToken('user-123', '123456');
```

### Authorization Service

#### `hasPermission(context, permissionCheck)`
Check if user has specific permission.

```typescript
const canAccess = await security.authorization.hasPermission(
  req.security, // Security context from middleware
  {
    resource: 'document',
    action: 'read',
    conditions: { documentType: 'contract' }
  }
);
```

#### `requirePermission(context, permissionCheck)`
Require permission or throw authorization error.

```typescript
await security.authorization.requirePermission(
  req.security,
  { resource: 'matter', action: 'update' }
);
```

#### `canAccessOrganization(context, organizationId)`
Check organization access permissions.

```typescript
const canAccess = await security.authorization.canAccessOrganization(
  req.security,
  'org-456'
);
```

### Encryption Service

#### `encrypt(data, level, keyId?)`
Encrypt sensitive data with specified security level.

```typescript
const encrypted = await security.encryption.encrypt(
  'Confidential client information',
  EncryptionLevel.ENHANCED
);
```

#### `decrypt(encryptedData)`
Decrypt previously encrypted data.

```typescript
const decrypted = await security.encryption.decrypt(encrypted);
```

#### `encryptFile(fileBuffer, level?)`
Encrypt file data.

```typescript
const fileBuffer = fs.readFileSync('contract.pdf');
const encrypted = await security.encryption.encryptFile(
  fileBuffer,
  EncryptionLevel.MAXIMUM
);
```

#### `hash(data, salt?)`
One-way hash for sensitive data.

```typescript
const hashed = security.encryption.hash('client-ssn-123456789');
```

#### `generateSecurePassword(length?)`
Generate cryptographically secure password.

```typescript
const password = security.encryption.generateSecurePassword(16);
```

### Security Middleware

#### `authenticate(options?)`
Authentication middleware for Express routes.

```typescript
// Required authentication
app.use('/api/protected', middleware.authenticate());

// Optional authentication
app.use('/api/public', middleware.authenticate({ optional: true }));
```

#### `authorize(permissionCheck)`
Authorization middleware for Express routes.

```typescript
app.delete('/api/documents/:id',
  middleware.authenticate(),
  middleware.authorize({
    resource: 'document',
    action: 'delete'
  })
);
```

#### `validateInput(validations)`
Input validation middleware.

```typescript
app.post('/api/users',
  middleware.validateInput([
    ValidationSchemas.email,
    ValidationSchemas.password,
    ValidationSchemas.requiredString('firstName')
  ])
);
```

## üèõÔ∏è Legal Domain Security

### Document Classification

```typescript
import { LegalSecurityUtils, EncryptionLevel } from '@courtlens/security';

const legalSecurity = new LegalSecurityUtils(security.encryption);

// Encrypt based on document classification
const encrypted = await legalSecurity.encryptLegalDocument(
  documentContent,
  'confidential' // Maps to EncryptionLevel.ENHANCED
);
```

### Client Data Protection

```typescript
// Hash sensitive client information
const hashedSSN = legalSecurity.hashClientInfo(clientSSN);
const hashedDOB = legalSecurity.hashClientInfo(clientDateOfBirth);

// Generate secure document IDs
const documentId = legalSecurity.generateSecureDocumentId();
```

### Role-Based Permissions

```typescript
// Legal-specific roles with default permissions
const roles = {
  SUPER_ADMIN: ['*:*'],
  ORG_ADMIN: ['organization:*', 'user:*', 'document:*'],
  PARTNER: ['document:*', 'matter:*', 'client:*'],
  SENIOR_ASSOCIATE: ['document:read,write', 'matter:read,write'],
  ASSOCIATE: ['document:read', 'matter:read'],
  PARALEGAL: ['document:read', 'matter:read'],
  CLIENT: ['document:read:own', 'matter:read:own'],
  GUEST: []
};
```

## üîí Security Levels

### Encryption Levels

| Level | Algorithm | Key Size | Iterations | Use Case |
|-------|-----------|----------|------------|----------|
| STANDARD | AES-256-CBC | 256-bit | 10,000 | Internal documents |
| ENHANCED | AES-256-GCM | 256-bit | 50,000 | Client documents |
| MAXIMUM | AES-256-GCM | 256-bit | 100,000 | Privileged documents |

### Document Classifications

| Classification | Encryption Level | Access Control | Audit Required |
|----------------|------------------|----------------|----------------|
| PUBLIC | STANDARD | Open | No |
| INTERNAL | STANDARD | Organization | No |
| CONFIDENTIAL | ENHANCED | Role-based | Yes |
| RESTRICTED | MAXIMUM | Explicit permission | Yes |
| TOP_SECRET | MAXIMUM | Need-to-know | Yes |

## üìä Security Monitoring

### Event Types

```typescript
enum SecurityEventType {
  LOGIN_SUCCESS = 'login_success',
  LOGIN_FAILURE = 'login_failure',
  LOGOUT = 'logout',
  PASSWORD_CHANGE = 'password_change',
  MFA_ENABLED = 'mfa_enabled',
  MFA_DISABLED = 'mfa_disabled',
  ACCOUNT_LOCKED = 'account_locked',
  PERMISSION_DENIED = 'permission_denied',
  DATA_ACCESS = 'data_access',
  DATA_MODIFICATION = 'data_modification',
  SECURITY_VIOLATION = 'security_violation',
  SUSPICIOUS_ACTIVITY = 'suspicious_activity'
}
```

### Risk Levels

```typescript
enum RiskLevel {
  LOW = 'low',        // Normal operations
  MEDIUM = 'medium',  // Unusual but not concerning
  HIGH = 'high',      // Requires attention
  CRITICAL = 'critical' // Immediate response required
}
```

### Custom Security Events

```typescript
await security.eventService.logEvent({
  id: crypto.randomUUID(),
  type: SecurityEventType.DATA_ACCESS,
  userId: req.security.user.id,
  organizationId: req.security.user.organizationId,
  ipAddress: req.ip,
  userAgent: req.get('User-Agent'),
  resource: 'client_data',
  action: 'export',
  details: {
    clientId: 'client-123',
    recordCount: 500,
    exportFormat: 'pdf'
  },
  riskLevel: RiskLevel.MEDIUM,
  timestamp: new Date()
});
```

## üß™ Testing

### Running Tests

```bash
cd packages/security
pnpm test
pnpm test:coverage
pnpm test:watch
```

### Test Categories

- **Unit Tests**: Individual service functionality
- **Integration Tests**: Service interaction and Supabase integration
- **Security Tests**: Vulnerability and penetration testing
- **Performance Tests**: Load and stress testing
- **Compliance Tests**: Legal and regulatory compliance

### Example Test

```typescript
describe('Authentication Service', () => {
  it('should enforce password policy', async () => {
    await expect(
      authService.register({
        email: 'test@example.com',
        password: 'weak', // Weak password
        firstName: 'Test',
        lastName: 'User',
        organizationId: 'org-123'
      }, {})
    ).rejects.toThrow('Password must contain');
  });

  it('should prevent brute force attacks', async () => {
    // Simulate multiple failed login attempts
    for (let i = 0; i < 5; i++) {
      try {
        await authService.login({
          email: 'test@example.com',
          password: 'wrongpassword'
        }, { ipAddress: '192.168.1.100' });
      } catch (error) {
        // Expected to fail
      }
    }

    // Next attempt should be blocked
    await expect(
      authService.login({
        email: 'test@example.com',
        password: 'correctpassword'
      }, { ipAddress: '192.168.1.100' })
    ).rejects.toThrow('Account temporarily locked');
  });
});
```

## üîß Configuration

### Environment Variables

```env
# Supabase Configuration
SUPABASE_URL=https://qzkopgqmymorpngpabvq.supabase.co
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# JWT Configuration
JWT_SECRET=your_super_secret_jwt_key
JWT_EXPIRES_IN=1h

# Security Configuration
ENCRYPTION_DEFAULT_LEVEL=enhanced
LOG_LEVEL=info
ENABLE_REAL_TIME_ALERTS=true

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
AUTH_RATE_LIMIT_MAX_REQUESTS=5

# CORS Configuration
ALLOWED_ORIGINS=http://localhost:3000,https://app.courtlens.com
```

### Security Policies

```typescript
const securityConfig = {
  passwordPolicy: {
    minLength: 8,
    requireUppercase: true,
    requireLowercase: true,
    requireNumbers: true,
    requireSpecialChars: true,
    maxAge: 90, // days
    preventReuse: 5
  },
  sessionPolicy: {
    timeoutMinutes: 60,
    maxConcurrentSessions: 3,
    requireMfaForSensitive: true
  },
  auditPolicy: {
    logAllDataAccess: true,
    retentionDays: 2555, // 7 years for legal compliance
    enableRealTimeAlerts: true
  }
};
```

## üö® Security Best Practices

### 1. Authentication

- Always use HTTPS in production
- Implement MFA for administrative accounts
- Use strong password policies
- Monitor for suspicious login patterns
- Implement account lockout mechanisms

### 2. Authorization

- Follow principle of least privilege
- Use role-based access control
- Regularly audit permissions
- Implement resource-level permissions
- Log all authorization decisions

### 3. Data Protection

- Encrypt sensitive data at rest
- Use appropriate encryption levels
- Implement secure key management
- Hash irreversible data (SSNs, etc.)
- Follow data retention policies

### 4. Monitoring

- Log all security events
- Monitor for anomalous behavior
- Set up real-time alerts
- Regularly review audit logs
- Implement automated threat detection

### 5. Compliance

- Follow legal industry standards
- Implement data retention policies
- Ensure audit trail completeness
- Regular security assessments
- Staff security training

## üìã Compliance Features

### Legal Industry Standards

- **ABA Model Rules** compliance monitoring
- **GDPR/CCPA** privacy protection
- **SOX** financial controls (if applicable)
- **HIPAA** healthcare data protection (if applicable)

### Audit Requirements

- Complete audit trail for all data access
- User activity monitoring
- Document access logging
- Change management tracking
- Compliance reporting capabilities

### Data Retention

- Configurable retention policies
- Automatic data archival
- Legal hold capabilities
- Secure data deletion
- Retention schedule management

## üîÑ Health Checks

```typescript
import { getSecurityHealthStatus } from '@courtlens/security';

app.get('/health/security', (req, res) => {
  const health = getSecurityHealthStatus();
  res.status(health.status === 'healthy' ? 200 : 503).json(health);
});
```

## üìû Support

For security issues or questions:

1. **Critical Security Issues**: Report immediately to [security@courtlens.com](mailto:security@courtlens.com)
2. **General Questions**: Create an issue in the repository
3. **Documentation**: See inline code documentation
4. **Examples**: Check the `examples/` directory

---

## ‚ö†Ô∏è Security Notice

This security framework handles sensitive legal data. Always:

- Keep dependencies updated
- Regular security audits
- Monitor for vulnerabilities
- Follow secure coding practices
- Implement proper key management
- Use environment-specific configurations

**Never commit secrets or keys to version control.**
 
 