name: Weekly Backup Restore Drill

on:
  schedule:
    # Run every Sunday at 4 AM UTC
    - cron: '0 4 * * 0'
  workflow_dispatch:
    inputs:
      keep_backup:
        description: 'Keep backup file after drill'
        required: false
        default: 'true'
        type: boolean

jobs:
  backup-restore-drill:
    name: Database Backup Restoration Test
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PostgreSQL client tools
        run: |
          # Download and install PostgreSQL client
          $pgVersion = "16.1-1"
          $installerUrl = "https://get.enterprisedb.com/postgresql/postgresql-$pgVersion-windows-x64-binaries.zip"
          
          Write-Host "Downloading PostgreSQL client tools..."
          Invoke-WebRequest -Uri $installerUrl -OutFile "pg.zip"
          
          Write-Host "Extracting..."
          Expand-Archive -Path "pg.zip" -DestinationPath "pg" -Force
          
          Write-Host "Adding to PATH..."
          $pgBinPath = Join-Path $PWD "pg\pgsql\bin"
          echo "$pgBinPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          Write-Host "âœ… PostgreSQL client tools installed"
      
      - name: Run backup restore drill
        id: drill
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
        run: |
          $keepBackup = "${{ github.event.inputs.keep_backup || 'true' }}" -eq "true"
          
          .\scripts\backup-restore-drill.ps1 `
            -BackupDir ".\drill-backups" `
            -TestDbName "union_eyes_drill_test" `
            -KeepBackup $keepBackup `
            -Verbose
        shell: pwsh
        continue-on-error: false
      
      - name: Upload backup artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backup-drill-${{ github.run_number }}
          path: drill-backups/
          retention-days: 7
      
      - name: Generate drill report
        if: always()
        run: |
          echo "# ðŸ’¾ Backup Restore Drill Report" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "**Date**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" >> $env:GITHUB_STEP_SUMMARY
          echo "**Environment**: Staging" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          
          if ($LASTEXITCODE -eq 0) {
            echo "## âœ… Drill Status: **PASSED**" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            echo "All backup and restore validations completed successfully." >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            echo "### Validated:" >> $env:GITHUB_STEP_SUMMARY
            echo "- âœ… Backup creation" >> $env:GITHUB_STEP_SUMMARY
            echo "- âœ… Database restoration" >> $env:GITHUB_STEP_SUMMARY
            echo "- âœ… Schema integrity" >> $env:GITHUB_STEP_SUMMARY
            echo "- âœ… Data integrity" >> $env:GITHUB_STEP_SUMMARY
            echo "- âœ… Critical queries" >> $env:GITHUB_STEP_SUMMARY
          } else {
            echo "## âŒ Drill Status: **FAILED**" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            echo "âš ï¸ One or more validation steps failed. Review the logs." >> $env:GITHUB_STEP_SUMMARY
          }
        shell: pwsh
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âŒ Weekly Backup Restore Drill Failed',
              body: `## Backup Restore Drill Failure
              
              The weekly backup restore drill has failed.
              
              **Workflow Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              **Date**: ${new Date().toISOString()}
              
              ### Action Required
              - Review the workflow logs
              - Verify database connectivity
              - Check PostgreSQL client tools
              - Validate backup integrity
              
              ### Potential Issues
              - Database connectivity problems
              - Insufficient disk space
              - Schema changes requiring migration
              - Data corruption
              
              **Priority**: HIGH - This affects disaster recovery capability`,
              labels: ['backup', 'reliability', 'priority-high', 'automated-issue']
            });
      
      - name: Post success notification
        if: success()
        run: |
          Write-Host "âœ… Backup restore drill completed successfully" -ForegroundColor Green
          Write-Host ""
          Write-Host "Your backups are verified restorable." -ForegroundColor Green

  compliance-check:
    name: Verify Backup Compliance
    runs-on: ubuntu-latest
    needs: backup-restore-drill
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check backup retention policy
        run: |
          echo "# ðŸ“‹ Backup Compliance Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backup restore drill passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Compliance requirements met:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Weekly restoration testing" >> $GITHUB_STEP_SUMMARY
          echo "- Schema validation" >> $GITHUB_STEP_SUMMARY
          echo "- Data integrity verification" >> $GITHUB_STEP_SUMMARY
          echo "- Recovery time objective (RTO) verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Drill**: Scheduled for next Sunday at 4 AM UTC" >> $GITHUB_STEP_SUMMARY
